---

on:
  workflow_call:

jobs:
  open-release-pr:
    name: Release pull request
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v5

      - name: Get next version
        uses: MiguelRipoll23/get-next-version@v3.0.0
        id: get-next-version
        with:
          major-labels: backwards-incompatible,breaking,removal
          minor-labels: feature,enhancement,improvement
          patch-labels: bug

      - name: Update version in pyproject.toml
        run: uvx --from=toml-cli toml set --toml-path=pyproject.toml project.version ${{ env.NEXT_VERSION }}
        env:
          NEXT_VERSION: ${{ steps.get-next-version.outputs.next-version }}

      - name: Generate release changelog
        uses: janheinrichmerker/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          futureRelease: ${{ steps.get-next-version.outputs.next-version }}
          breakingLabels: backwards-incompatible,breaking
          removedLabels: removal
          enhancementLabels: feature,enhancement,improvement
          bugLabels: bug
          excludeLabels: skip-changelog
          output: CHANGELOG.md
          usernamesAsGithubLogins: true
          stripGeneratorNotice: true

      - name: Create git tag
        uses: rickstaa/action-create-tag@v1
        with:
          tag: "v${{ steps.get-next-version.outputs.next-version }}"

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: release-${{ steps.get-next-version.outputs.next-version }}
          commit-message: release ${{ steps.get-next-version.outputs.next-version }}
          title: Release ${{ steps.get-next-version.outputs.next-version }}
          body: Automated pull request triggered by a new release.
          labels: skip-changelog
          draft: true
